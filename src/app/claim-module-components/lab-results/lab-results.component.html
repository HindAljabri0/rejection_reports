<div class="item-group-panel">
    <div class="parent-panel">
        <ul>
            <li class="title">Results</li>
            <li *ngFor="let result of resultsControls; let i = index" [class.active]="expandedResult == i">
                <button type="button" title="Result {{(i+1)}}" class="list-btn" [class.text-danger]="resultHasErrors(i)" (click)="toggleResult(i)">
                    <p>
                        Result {{(i+1)}}
                        <mat-icon *ngIf="resultHasErrors(i)">error</mat-icon>
                    </p>
                    <span class="right-block">
                        <p>{{formatDate(result.testDate.value)}}</p>
                    </span>
                </button>
                <button type="button" class="delete-btn text-danger" (click)="onDeleteResultClick(i)" *ngIf="pageMode == 'EDIT'">
                    <mat-icon>delete_outline</mat-icon>
                </button>
            </li>
        </ul>
        <button mat-flat-button class="mt-2" *ngIf="pageMode != 'VIEW'" color="primary" (click)="onAddResultClick()">Add Result</button>
    </div>
    <ng-container *ngFor="let result of resultsControls; let i = index">
        <div class="child-panel" *ngIf="expandedResult != -1 && expandedResult == i">
            <p class="block-title mb-2">Result {{(i+1)}}</p>
            <div class="row small-gutter">
                <div class="col-md-6">
                    <div class="form-group" [matTooltip]="getFieldError('testDate:'+i)" [class.has-error]="fieldHasError('testDate:'+i)">
                        <label class="control-label">Test Date</label>
                        <input [formControl]="result.testDate" class="form-control" type="date">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group" [class.has-error]="fieldHasError('testCode:'+i)" [matTooltip]="getFieldError('testCode:'+i)">
                        <label class="control-label">Test Code<span class="asterisk">*</span></label>
                        <input [formControl]="result.testCode" class="form-control">
                    </div>
                </div>
            </div>
            <div class="form-group" [class.has-error]="fieldHasError('resultDescription:'+i)" [matTooltip]="getFieldError('resultDescription:'+i)">
                <label class="control-label">Description</label>
                <textarea rows="4" placeholder="Description" [formControl]="result.resultDescription" class="form-control"></textarea>
            </div>
            <p class="block-title">Components</p>
            <div class="list-expansion-panel">
                <mat-expansion-panel *ngFor="let component of result.componentsControls; let j = index" [expanded]="component.isOpen" hideToggle>
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <button (click)="toggleComponentExpansion($event,i,j)" [class.text-danger]="componentHasErrors(i, j)" class="toggle-btn">
                                Component {{(j+1)}}
                                <mat-icon *ngIf="componentHasErrors(i, j)">error</mat-icon>
                            </button>
                            <button (click)="onDeleteComponentClick($event, i, j)" class="text-danger delete-btn" *ngIf="pageMode == 'EDIT'">
                                <mat-icon>delete_outline</mat-icon>
                            </button>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="row small-gutter">
                        <div class="col-md-4">
                            <div class="form-group" [class.has-error]="fieldHasError('componentCode:'+i+':'+j)" [matTooltip]="getFieldError('componentCode:'+i+':'+j)">
                                <label class="control-label">Component Code<span class="asterisk">*</span></label>
                                <input [formControl]="component.componentCode" class="form-control" type="text">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group" [class.has-error]="fieldHasError('componentLabResult:'+i+':'+j)" [matTooltip]="getFieldError('componentLabResult:'+i+':'+j)">
                                <label class="control-label">LAB Result</label>
                                <input [formControl]="component.componentLabResult" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group" [class.has-error]="fieldHasError('componentResultUnit:'+i+':'+j)" [matTooltip]="getFieldError('componentResultUnit:'+i+':'+j)">
                                <label class="control-label">Result Unit</label>
                                <input [formControl]="component.componentResultUnit" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" [class.has-error]="fieldHasError('componentDescription:'+i+':'+j)" [matTooltip]="getFieldError('componentDescription:'+i+':'+j)">
                        <label class="control-label">Description</label>
                        <textarea placeholder="Description" [formControl]="component.componentDescription" class="form-control"></textarea>
                    </div>
                </mat-expansion-panel>
            </div>
            <div class="text-right mt-2" *ngIf="pageMode != 'VIEW'">
                <button mat-flat-button color="primary" (click)="onAddComponentClick(i)">Add Component</button>
            </div>
        </div>
    </ng-container>
</div>