<div class="body">
    <table *ngIf="expandedInvoice == -1" class="headerTable">
        <tr style="font-size: small;">
            <th style="width: 16%;"></th>
            <th style="width: 16%;">Invoice No.</th>
            <th style="width: 16%;">Invoice Date</th>
            <th style="width: 22%;">
                <div style="width: 100%; display: flex;">
                    <span>Net Amount</span>
                    <span style="flex: 0.8 1 auto;"></span>
                    <span>Vat</span>
                </div>
            </th>
            <th style="width: 16%;">No. of Services</th>
            <th style="width: 10%;"></th>
        </tr>
    </table>
    <div *ngFor="let invoice of controllers; let i = index" class="invoices">
        <mat-expansion-panel *ngIf="expandedInvoice == -1 || expandedInvoice == i" hideToggle
            [expanded]="i == expandedInvoice" (afterExpand)="afterInvoiceExpanded(i)"
            (afterCollapse)="afterInvoiceCollapse(i)">
            <mat-expansion-panel-header>
                <table class="headerTable child">
                    <tr style="font-size: small;">
                        <td style="width: 16%;">
                            <mat-icon *ngIf="invoiceHasErrors(i)" style="color: #bb3131;">error</mat-icon>
                            Invoice {{(i+1)}}
                        </td>
                        <td style="width: 16%;" *ngIf="expandedInvoice == -1">{{invoice.invoice.invoiceNumber}}</td>
                        <td style="width: 16%;" *ngIf="expandedInvoice == -1">
                            {{invoice.invoice.invoiceDate | date:"dd/MM/yyyy"}}
                        </td>
                        <td style="width: 22%;" *ngIf="expandedInvoice == -1">
                            <div style="width: 100%; display: flex;">
                                <span>{{invoice.invoice.invoiceGDPN.net.value}}</span>
                                <span class="spacer"></span>
                                <span>{{invoice.invoice.invoiceGDPN.netVATamount.value}}</span>
                            </div>
                        </td>
                        <td style="width: 16%;" *ngIf="expandedInvoice == -1">{{invoice.services.length}}</td>
                        <td style="width: 10%;" *ngIf="expandedInvoice == -1">
                            <button mat-icon-button (click)="onDeleteInvoiceClick($event, i)"
                                *ngIf="(pageMode == 'CREATE' || pageMode == 'CREATE_FROM_RETRIEVED') && controllers.length > 1">
                                <mat-icon style="color: #af4848;">cancel</mat-icon>
                            </button>
                        </td>
                        <td *ngIf="(pageMode == 'CREATE' || pageMode == 'CREATE_FROM_RETRIEVED') && expandedInvoice != -1"
                            colspan="5" style="text-align: end;"><button mat-button style="margin-left: auto;"
                                *ngIf="i == expandedInvoice" (click)="onAddAnathorInvoiceClick($event, i)">+ Add Another
                                Invoice</button></td>
                    </tr>
                </table>
            </mat-expansion-panel-header>
            <table>
                <tr>
                    <td><label>Invoice Number*</label></td>
                    <td><label>Invoice Date*</label></td>
                    <td><label>Invoice Department*</label></td>
                </tr>
                <tr>
                    <td [matTooltip]="getFieldError('invoiceNumber:'+i)"><input
                            [ngClass]="{'fieldError': fieldHasError('invoiceNumber:'+i)}" type="text"
                            [formControl]="invoice.invoiceNumber"></td>
                    <td [matTooltip]="getFieldError('invoiceDate:'+i)"><input type="date"
                            [ngClass]="{'fieldError': fieldHasError('invoiceDate:'+i)}"
                            [formControl]="invoice.invoiceDate"></td>
                    <td>
                        <select (change)="updateInvoiceDepartment(i, $event)"
                            [value]="controllers[i].invoice.invoiceDepartment"
                            [disabled]="pageMode != 'CREATE' && pageMode != 'CREATE_FROM_RETRIEVED'" required>
                            <option *ngFor="let department of departments" [value]="department.departmentId">
                                {{department.name}}</option>
                        </select>
                    </td>
                </tr>
            </table>
        </mat-expansion-panel>
        <div *ngIf="i == expandedInvoice">
            <div *ngFor="let service of invoice.services; let j = index " class="services">
                <mat-expansion-panel class="serviceExpansionPanel" *ngIf="expandedService == -1 || expandedService == j"
                    hideToggle [expanded]="j == expandedService" (afterExpand)="afterServiceExpanded(j)"
                    (afterCollapse)="afterServiceCollapse(i, j)">
                    <mat-expansion-panel-header>
                        <mat-panel-title style="color: #3060AA;">
                            <mat-icon *ngIf="serviceHasErrors(i, j)" style="color: #bb3131;">error</mat-icon>
                            Service {{(j+1)}}
                            <span class="spacer"></span>
                            <span *ngIf="service.statusCode != null" style="font-weight: 600;"
                                [style.color]="getStatusColor(service.statusCode)">{{getStatusText(service.statusCode)}}</span>
                        </mat-panel-title>
                        <mat-panel-description *ngIf="pageMode != 'VIEW'">
                            <button mat-button style="margin-left: auto;"
                                *ngIf="pageMode == 'CREATE_FROM_RETRIEVED' && !service.retrieved && j == expandedService"
                                (click)="onSelectRetrievedServiceClick($event, i, j)">Select a retrieved
                                service</button>
                            <button mat-button *ngIf="j == expandedService"
                                [ngStyle]="{'margin-left': service.retrieved? 'auto': 'unset'}"
                                (click)="onAddAnathorServiceClick($event, i, j)">+ Add Another
                                Service</button>
                            <button mat-icon-button (click)="onDeleteServiceClick($event, i, j)"
                                *ngIf="controllers[i].services.length > 1 && expandedService == -1">
                                <mat-icon style="color: #af4848;">cancel</mat-icon>
                            </button>
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="serviceAutoCalc">
                        <div class="left autoCalcElement">
                            <label>Gross Amount</label>
                            <h3>{{calcGross(controllers[i].services[j])}}</h3>
                        </div>
                        <div class="middle autoCalcElement">
                            <div style="display: flex;">
                                <label>Net Amount</label>
                                <span class="spacer"></span>
                                <label>Vat</label>
                            </div>
                            <div style="display: flex;">
                                <h3>{{calcNet(controllers[i].services[j])}}</h3>
                                <span class="spacer"></span>
                                <h3>{{calcNetVat(controllers[i].services[j])}}</h3>
                            </div>
                        </div>
                        <div class="right autoCalcElement">
                            <label>Patient Share Vat Amount</label>
                            <h3>{{calcPatientVatRate(controllers[i].services[j])}}</h3>
                        </div>
                        <div class="autoCalcElement" style="grid-column: 4 / 5;"
                            [style.color]="getStatusColor(service.statusCode)"
                            [style.background-color]="getStatusColor(service.statusCode)+'10'"
                            [style.border-color]="getStatusColor(service.statusCode)"
                            *ngIf="service.statusCode != null">
                            <label>Actual Deducted Amount</label>
                            <h3>{{service.acutalDeductedAmount}}</h3>
                        </div>
                        <div class="autoCalcElement" style="grid-column: 5 / 6;"
                            [style.color]="getStatusColor(service.statusCode)"
                            [style.background-color]="getStatusColor(service.statusCode)+'10'"
                            [style.border-color]="getStatusColor(service.statusCode)"
                            *ngIf="service.statusCode != null">
                            <label>Actual Paid Amount</label>
                            <h3>{{calcNet(controllers[i].services[j]) - service.acutalDeductedAmount}}</h3>
                        </div>
                    </div>
                    <table class="serviceDetailsForm">
                        <tr>
                            <td><label>Service Code*</label></td>
                            <td [matTooltip]="getFieldError('serviceCode:'+i+':'+j)">
                                <input [ngClass]="{'fieldError': fieldHasError('serviceCode:'+i+':'+j)}" type="text"
                                    [formControl]="service.serviceCode">
                                <span *ngIf="pageMode != 'VIEW' && !service.retrieved" class="selectServiceButton"
                                    [matMenuTriggerFor]="editServiceCodeMenu">Select</span>
                            </td>
                            <td><label>Service Description*</label></td>
                            <td [matTooltip]="getFieldError('serviceDescription:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('serviceDescription:'+i+':'+j)}"
                                    [formControl]="service.serviceDescription" type="text"></td>
                        </tr>
                        <tr>
                            <td><label>Service Date*</label></td>
                            <td [matTooltip]="getFieldError('serviceDate:'+i+':'+j)">
                                <input matInput [matDatepicker]="picker"
                                    [ngClass]="{'fieldError': fieldHasError('serviceDate:'+i+':'+j)}"
                                    [formControl]="service.serviceDate" style="width: 80%;">
                                <mat-datepicker-toggle [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </td>
                            <td><label>Unit Price*</label></td>
                            <td [matTooltip]="getFieldError('serviceUnitPrice:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('serviceUnitPrice:'+i+':'+j)}" type="number"
                                    [formControl]="service.unitPrice"><span class="amountType">SAR</span>
                            </td>
                        </tr>
                        <tr>
                            <td><label>Quantity*</label></td>
                            <td [matTooltip]="getFieldError('serviceQuantity:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('serviceQuantity:'+i+':'+j)}" type="text"
                                    [formControl]="service.quantity"></td>
                            <td><label>Patient Share</label></td>
                            <td [matTooltip]="getFieldError('servicePatientShare:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('servicePatientShare:'+i+':'+j)}"
                                    type="number" [formControl]="service.patientShare"><span
                                    class="amountType">SAR</span>
                            </td>
                        </tr>
                        <tr>
                            <td><label>Service Discount</label></td>
                            <td [matTooltip]="getFieldError('serviceDiscount:'+i+':'+j)">
                                <input [ngClass]="{'fieldError': fieldHasError('serviceDiscount:'+i+':'+j)}"
                                    type="number" [formControl]="service.serviceDiscount">
                                <span class="amountType" style="cursor: pointer; color: #3060AA;"
                                    [ngClass]="{'amountTypePerecent': service.serviceDiscountUnit == 'PERCENT'}"
                                    (click)="service.serviceDiscount.disabled? null :  (service.serviceDiscountUnit = (service.serviceDiscountUnit == 'SAR'? 'PERCENT':'SAR'))">{{service.serviceDiscountUnit
                                    == 'SAR'? 'SAR':'%'}}</span>
                            </td>
                            <td><label>Net Vat Rate*</label></td>
                            <td [matTooltip]="getFieldError('serviceNetVatRate:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('serviceNetVatRate:'+i+':'+j)}"
                                    type="number" [formControl]="service.netVatRate"><span
                                    class="amountType amountTypePerecent">%</span></td>
                        </tr>
                        <tr>
                            <td><label>Patient Share Vat Rate*</label></td>
                            <td [matTooltip]="getFieldError('servicePatientShareVatRate:'+i+':'+j)"><input
                                    [ngClass]="{'fieldError': fieldHasError('servicePatientShareVatRate:'+i+':'+j)}"
                                    type="number" [formControl]="service.patientShareVatRate"><span
                                    class="amountType amountTypePerecent">%</span></td>
                            <td *ngIf="claimType == dentalDepartmentCode"><label>Tooth Number*</label></td>
                            <td *ngIf="claimType == dentalDepartmentCode"
                                [matTooltip]="getFieldError('serviceToothNumber:'+i+':'+j)">
                                <input [ngClass]="{'fieldError': fieldHasError('serviceToothNumber:'+i+':'+j)}"
                                    type="number" [formControl]="service.toothNumber">
                                <span *ngIf="pageMode != 'VIEW' && !service.toothNumber.disabled"
                                    class="selectServiceButton" [matMenuTriggerFor]="SelectToothMenu">Select</span>
                            </td>
                        </tr>
                    </table>
                </mat-expansion-panel>
            </div>
        </div>
        <div style="text-align: end;" *ngIf="pageMode != 'VIEW' && expandedService == -1 && expandedInvoice == i">
            <hr>
            <button mat-raised-button *ngIf="pageMode == 'CREATE_FROM_RETRIEVED'" color="primary"
                (click)="onAddRetrievedServiceClick(i)" style="margin-right: 10px;">Add a Retreived Service</button>
            <button mat-raised-button color="primary" (click)="onAddServiceClick(i)">Add Service</button>
        </div>
    </div>
    <div style="text-align: end;"
        *ngIf="(pageMode == 'CREATE' || pageMode == 'CREATE_FROM_RETRIEVED') && expandedInvoice == -1">
        <hr>
        <button mat-raised-button color="primary" (click)="onAddInvoiceClick()">Add Invoice</button>
    </div>
</div>


<mat-menu #editServiceCodeMenu>
    <mat-form-field *ngIf="priceListExist" style="width: 80%; margin: 20px 10px 20px 20px;"
        (click)="$event.stopPropagation()">
        <input type="text" placeholder="Search Service Code" matInput [formControl]="searchServicesController"
            [matAutocomplete]="servicesOptionsAutoComplete" (keyup)="searchServices()"
            (click)="$event.stopPropagation()">
        <mat-autocomplete #servicesOptionsAutoComplete style="width: fit-content;">
            <mat-option *ngFor="let option of servicesOptions" (click)="selectService(option);">
                {{option}}
            </mat-option>
            <mat-option *ngIf="emptyOptions && serviceCodeSearchError == null">No results found, or price list does not
                exist.</mat-option>
            <mat-option *ngIf="serviceCodeSearchError != null">Could not reach server at the moment. Please try again
                later.</mat-option>
        </mat-autocomplete>
    </mat-form-field>
    <p *ngIf="!priceListExist" style="width: 90%; margin: 20px 10px 20px 20px; color: #f59517;">Price list does not
        exist! <mat-icon style="display: inline; font-size: 15px;">error</mat-icon>
    </p>
</mat-menu>
<mat-menu #SelectToothMenu>
    <div style="display: grid; place-items: center;">
        <h4 style="text-align: center;">Click on the tooth to select</h4>
        <img src="assets/toothsList.jpg" alt="">
        <div style="width: 0px; height: 0px;">
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 527px; right: 33px;"
                (click)="selectTooth(11)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 556px; right: 61px;"
                (click)="selectTooth(12)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 18px; bottom: 578px; right: 83px;"
                (click)="selectTooth(13)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 590px; right: 100px;"
                (click)="selectTooth(14)">
            </label>
            <label class="toothMenuItem" style="width: 35px; height: 24px; bottom: 603px; right: 118px;"
                (click)="selectTooth(15)">
            </label>
            <label class="toothMenuItem" style="width: 43px; height: 38px; bottom: 615px; right: 132px;"
                (click)="selectTooth(16)">
            </label>
            <label class="toothMenuItem" style="width: 44px; height: 35px; bottom: 627px; right: 141px;"
                (click)="selectTooth(17)">
            </label>
            <label class="toothMenuItem" style="width: 47px; height: 35px; bottom: 640px; right: 149px;"
                (click)="selectTooth(18)">
            </label>
            <label class="toothMenuItem" style="width: 36px; height: 24px; bottom: 858px; right: 1px;"
                (click)="selectTooth(21)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 891px; left: 34px;"
                (click)="selectTooth(22)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 914px; left: 58px;"
                (click)="selectTooth(23)">
            </label>
            <label class="toothMenuItem" style="width: 32px; height: 24px; bottom: 933px; left: 76px;"
                (click)="selectTooth(24)">
            </label>
            <label class="toothMenuItem" style="width: 37px; height: 29px; bottom: 944px; left: 86px;"
                (click)="selectTooth(25)">
            </label>
            <label class="toothMenuItem" style="width: 49px; height: 44px; bottom: 958px; left: 92px;"
                (click)="selectTooth(26)">
            </label>
            <label class="toothMenuItem" style="width: 48px; height: 34px; bottom: 972px; left: 95px;"
                (click)="selectTooth(27)">
            </label>
            <label class="toothMenuItem" style="width: 45px; height: 36px; bottom: 984px; left: 102px;"
                (click)="selectTooth(28)">
            </label>
            <label class="toothMenuItem" style="width: 28px; height: 24px; bottom: 730px; right: 1px;"
                (click)="selectTooth(31)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 24px; bottom: 773px; left: 26px;"
                (click)="selectTooth(32)">
            </label>
            <label class="toothMenuItem" style="width: 32px; height: 28px; bottom: 823px; left: 52px;"
                (click)="selectTooth(33)">
            </label>
            <label class="toothMenuItem" style="width: 32px; height: 29px; bottom: 887px; left: 75px;"
                (click)="selectTooth(34)">
            </label>
            <label class="toothMenuItem" style="width: 36px; height: 29px; bottom: 960px; left: 88px;"
                (click)="selectTooth(35)">
            </label>
            <label class="toothMenuItem" style="width: 45px; height: 36px; bottom: 1043px; left: 93px;"
                (click)="selectTooth(36)">
            </label>
            <label class="toothMenuItem" style="width: 40px; height: 33px; bottom: 1127px; left: 99px;"
                (click)="selectTooth(37)">
            </label>
            <label class="toothMenuItem" style="width: 40px; height: 31px; bottom: 1206px; left: 99px;"
                (click)="selectTooth(38)">
            </label>
            <label class="toothMenuItem" style="width: 25px; height: 24px; bottom: 1076px; right: 23px;"
                (click)="selectTooth(41)">
            </label>
            <label class="toothMenuItem" style="width: 26px; height: 25px; bottom: 1119px; right: 49px;"
                (click)="selectTooth(42)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 27px; bottom: 1171px; right: 72px;"
                (click)="selectTooth(43)">
            </label>
            <label class="toothMenuItem" style="width: 40px; height: 24px; bottom: 1233px; right: 99px;"
                (click)="selectTooth(44)">
            </label>
            <label class="toothMenuItem" style="width: 39px; height: 26px; bottom: 1297px; right: 110px;"
                (click)="selectTooth(45)">
            </label>
            <label class="toothMenuItem" style="width: 47px; height: 39px; bottom: 1378px; right: 128px;"
                (click)="selectTooth(46)">
            </label>
            <label class="toothMenuItem" style="width: 41px; height: 34px; bottom: 1465px; right: 135px;"
                (click)="selectTooth(47)">
            </label>
            <label class="toothMenuItem" style="width: 41px; height: 35px; bottom: 1550px; right: 137px;"
                (click)="selectTooth(48)">
            </label>
            <label class="toothMenuItem" style="width: 24px; height: 20px; bottom: 1865px; right: 21px;"
                (click)="selectTooth(51)">
            </label>
            <label class="toothMenuItem" style="width: 25px; height: 21px; bottom: 1890px; right: 40px;"
                (click)="selectTooth(52)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 20px; bottom: 1910px; right: 54px;"
                (click)="selectTooth(53)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 25px; bottom: 1928px; right: 68px;"
                (click)="selectTooth(54)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 1942px; right: 76px;"
                (click)="selectTooth(55)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 21px; bottom: 2045px; left: 4px;"
                (click)="selectTooth(61)">
            </label>
            <label class="toothMenuItem" style="width: 22px; height: 20px; bottom: 2072px; left: 27px;"
                (click)="selectTooth(62)">
            </label>
            <label class="toothMenuItem" style="width: 28px; height: 19px; bottom: 2090px; left: 40px;"
                (click)="selectTooth(63)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 24px; bottom: 2109px; left: 52px;"
                (click)="selectTooth(64)">
            </label>
            <label class="toothMenuItem" style="width: 28px; height: 24px; bottom: 2121px; left: 57px;"
                (click)="selectTooth(65)">
            </label>
            <label class="toothMenuItem" style="width: 20px; height: 21px; bottom: 1815px; left: 3px;"
                (click)="selectTooth(71)">
            </label>
            <label class="toothMenuItem" style="width: 23px; height: 21px; bottom: 1853px; left: 24px;"
                (click)="selectTooth(72)">
            </label>
            <label class="toothMenuItem" style="width: 26px; height: 21px; bottom: 1902px; left: 36px;"
                (click)="selectTooth(73)">
            </label>
            <label class="toothMenuItem" style="width: 28px; height: 24px; bottom: 1959px; left: 47px;"
                (click)="selectTooth(74)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 27px; bottom: 2024px; left: 54px;"
                (click)="selectTooth(75)">
            </label>
            <label class="toothMenuItem" style="width: 20px; height: 24px; bottom: 1999px; right: 18px;"
                (click)="selectTooth(81)">
            </label>
            <label class="toothMenuItem" style="width: 20px; height: 22px; bottom: 2040px; right: 37px;"
                (click)="selectTooth(82)">
            </label>
            <label class="toothMenuItem" style="width: 27px; height: 23px; bottom: 2092px; right: 51px;"
                (click)="selectTooth(83)">
            </label>
            <label class="toothMenuItem" style="width: 30px; height: 24px; bottom: 2149px; right: 63px;"
                (click)="selectTooth(84)">
            </label>
            <label class="toothMenuItem" style="width: 31px; height: 24px; bottom: 2211px; right: 72px;"
                (click)="selectTooth(85)">
            </label>
        </div>
    </div>
</mat-menu>